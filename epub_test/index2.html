<html>
    <head>
        <style>
            #content {
                display: none;
            }
            #prev {
                display: block;
                position: fixed;
                top: 0;
                left: 0;
                width: 5vw;
                height: 100vh;
                background-color: red;
            }
            #next {
                display: block;
                position: fixed;
                top: 0;
                right: 0;
                width: 5vw;
                height: 100vh;
                background-color: blue;
            }
            #page {
                border: 1px solid red;
                padding: 2em;
                margin: 5vw;
                width: 50vw;
                font-size: 1.2em;
            }
        </style>
        <script>
            function getData(callback) {
                var xhttp = new XMLHttpRequest()
                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200 && this.responseText.length > 0) {
                        extractContents(this.responseText)
                        findPages()
                        if (callback != null) callback()
                    }
                }
                xhttp.open("GET", "part0005.html", true)
                xhttp.send()
            }
            function extractContents(data) {
                let parser = new DOMParser()
                let doc = parser.parseFromString(data, "text/html")
                let content = doc.querySelectorAll("body > *")
                var contentDiv = document.getElementById("content")
                for (var i = 0; i < content.length; i++) { 
                    contentDiv.appendChild(content[i])
                }
            }
            function findPages() {
                var pages = []
                var documentEnd = false
                var currentPosition = 0
                pages.push(currentPosition)
                while (! documentEnd) {
                    var result = loadPage(currentPosition, pages.length)
                    currentPosition = result.endPosition
                    pages.push(currentPosition)
                    documentEnd = result.documentEnd
                }
                clearPage()
                console.log(pages)
                document.pages = pages
                document.currentPage = 0
                fillPage(document.pages[0], document.pages[1], false)
            }

            function previousPage() {
                if (document.currentPage > 0) {
                    document.currentPage = document.currentPage - 1
                    fillPage(document.pages[document.currentPage], document.pages[document.currentPage + 1], false)
                } else {
                    console.log("beginning of doc")
                }
            }

            function nextPage() {
                // see if there is a next page
                if (document.currentPage < document.pages.length - 2) {
                    document.currentPage = document.currentPage + 1
                    fillPage(document.pages[document.currentPage], document.pages[document.currentPage + 1], false)
                } else {
                    console.log("end of doc")
                }
            }

            function loadPage(startPosition, pn) {
                //var jump = 10
                var endPosition = startPosition + 100
                var previousEndPosition = null

                clearPage()
                var documentEnd = false
                var returnedEnd = null
                var pageToLog = 1
                while ((! scrollNecessary()) && (! documentEnd) && (endPosition != previousEndPosition)) {
                    previousEndPosition = endPosition
                    var nextSpace = findSpaceAfter(endPosition)
                    if (pn == pageToLog) console.log("next space: " + nextSpace)
                    if (pn == pageToLog) console.log("char at next space: " + betterTextContent(document.getElementById("content")).charAt(nextSpace))
                    if (pn == pageToLog) console.log("char before next space: " + betterTextContent(document.getElementById("content")).charAt(nextSpace-1))
                    endPosition = nextSpace
                    returnedEnd = fillPage(startPosition, endPosition)
                    if (pn == pageToLog) console.log("returned end: " + returnedEnd)
                    if (returnedEnd < endPosition) {
                        documentEnd = true
                    }
                    if (pn == pageToLog) console.log("scroll necessary: " + scrollNecessary())
                }
                if (! documentEnd) {
                    if (pn == pageToLog) console.log("suggested end position: " + previousEndPosition)
                    var endpos = fillPage(startPosition, previousEndPosition)
                    if (pn == pageToLog) console.log("actual end position: " + endpos)
                    return { "endPosition": endpos, "documentEnd": false }
                } else {
                    return { "endPosition": returnedEnd, "documentEnd": true}
                }
            }
            function clearPage() {
                document.getElementById("page").innerHTML = ""
            }

            function fillPage(startPosition, endPosition) {
                var content = document.getElementById("content")
                var range = document.createRange()
                var startLocation = findLocation(content, startPosition)
                var endLocation = findLocation(content, endPosition)
                range.setStart(startLocation.element, startLocation.position)
                if (endLocation != null && endLocation.element) {
                    range.setEnd(endLocation.element, endLocation.position)
                } else {
                    var contentAll = document.querySelectorAll("#content > *")
                    var lastElement = contentAll[contentAll.length - 1]
                    range.setEndAfter(lastElement)
                }
                var page = document.getElementById("page")
                page.innerHTML = ""
                page.appendChild(range.cloneContents())
                if (endLocation.remaining) {
                    return endPosition - endLocation.remaining
                } else {
                    return endPosition
                }
            }

            function positionOfSpaceBefore(str, pos) {
                for (var i = pos; i > 0; i--) {
                    if (str.charAt(i) == ' ') return i
                }
                return 0
            }

            function findSpaceAfter(position) {
                var el = document.getElementById("content")
                var text = betterTextContent(el)
                for (var i = position + 1; i < text.length; i++) {
                    // treat multiple spaces as one ?
                    if (text.charAt(i) == ' '/* && text.charAt(i+1) != ' '*/) return i
                }
                return text.length
            }

            function betterTextContent(el) {
                if (el.nodeType == Node.TEXT_NODE) {
                    return el.nodeValue
                } else if (el.nodeType == Node.ELEMENT_NODE) {
                    var children = el.childNodes
                    var text = ""
                    for (var i = 0; i < children.length; i++) {
                        text = text + " " + betterTextContent(children[i])
                    }
                    return text
                } else return ""
            }

            function findLocation(el, position) {
                if (el.nodeType == Node.TEXT_NODE) {
                    if (el.nodeValue.length >= position) {
                        return { "element": el, "position": position }
                    } else {
                        return { "remaining": position - el.nodeValue.length}
                    }
                } else if (el.nodeType == Node.ELEMENT_NODE) {
                    var children = el.childNodes
                    var remainingPosition = position
                    for (var i = 0; i < children.length; i++) {
                        var result = findLocation(children[i], remainingPosition)
                        if (result.element) {
                            return result
                        } else {
                            remainingPosition = result.remaining
                        }
                    }
                    return { "remaining": remainingPosition}
                }
                return null
            }

            function scrollNecessary() {
                return (document.body.scrollWidth > document.body.clientWidth) || (document.body.scrollHeight > document.body.clientHeight)
            }
        </script>
    </head>
    <body>
        <div id="content"></div>
        <div id="prev"></div>
        <div id="next"></div>
        <div id="page"></div>
        <script>
            var prev = document.getElementById("prev")
            prev.addEventListener("click", function() {
                previousPage()
            })
            var next = document.getElementById("next")
            next.addEventListener("click", function() {
                nextPage()
            })

            getData()
        </script>
    </body>
</html>