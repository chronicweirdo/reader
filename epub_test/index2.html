<html>
    <head>
        <style>
            body {
                margin: 0;
                padding: 0;
                border: 0;
            }
            #content {
                display: none;
            }
            #prev {
                display: block;
                position: fixed;
                top: 0;
                left: 0;
                width: 5vw;
                height: 100vh;
                background-color: red;
            }
            #next {
                display: block;
                position: fixed;
                top: 0;
                right: 0;
                width: 5vw;
                height: 100vh;
                background-color: #0000ffaa;
            }
            #page {
                border: 1px solid #ff0000aa;
                padding: 1vw;
                margin: 5vw;
                width: 88vw;
                font-size: 1.2em;
            }
        </style>
        <script>
            function getData(callback) {
                var xhttp = new XMLHttpRequest()
                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200 && this.responseText.length > 0) {
                        extractContents(this.responseText)
                        if (callback != null) callback()
                    }
                }
                //xhttp.open("GET", "part0005.html", true)
                xhttp.open("GET", "18_chapter3_1.xhtml", true)
                //xhttp.open("GET", "SparkTheRevolu_chap_4.html", true)
                xhttp.send()
            }
            function extractContents(data) {
                let parser = new DOMParser()
                let doc = parser.parseFromString(data, "text/html")
                let content = doc.querySelectorAll("body > *")
                var contentDiv = document.getElementById("content")
                for (var i = 0; i < content.length; i++) { 
                    contentDiv.appendChild(content[i])
                }
            }

            function previousPage() {
                if (document.currentPage > 0) {
                    document.currentPage = document.currentPage - 1
                    copyTextToPage(getPositions(), document.pages[document.currentPage], document.pages[document.currentPage + 1])
                } else {
                    console.log("beginning of doc")
                }
            }

            function nextPage() {
                // see if there is a next page
                if (document.currentPage < document.pages.length - 2) {
                    document.currentPage = document.currentPage + 1
                    copyTextToPage(getPositions(), document.pages[document.currentPage], document.pages[document.currentPage + 1])
                } else {
                    console.log("end of doc")
                }
            }

            function clearPage() {
                document.getElementById("page").innerHTML = ""
            }

            function findSpaceAfter(str, pos) {
                for (var i = pos; i < str.length; i++) {
                    if (str.charAt(i) == ' ') return i
                }
                return str.length
            }

            function computeStartPositionsOfElements(root) {
                console.log("computing start positions of elements")
                var positionToElement = []
                var recursive = function(element, currentPosition) {
                    if (element.nodeType == Node.TEXT_NODE) {
                        positionToElement.push([currentPosition, element])
                        return currentPosition + element.nodeValue.length
                    } else if (element.nodeType == Node.ELEMENT_NODE) {
                        var children = element.childNodes
                        var newCurrentPosition = currentPosition
                        for (var i = 0; i < children.length; i++) {
                            newCurrentPosition = recursive(children[i], newCurrentPosition)
                        }
                        return newCurrentPosition
                    }
                }
                recursive(root, 0)
                return positionToElement
            }

            function getElementForPosition(positions, position) {
                for (var i = 1; i < positions.length; i++) {
                    if (positions[i][0] > position) return positions[i-1]
                }
                return positions[positions.length - 1]
            }
            function getPositions() {
                return document.positions
            }
            function setPositions(positions) {
                document.positions = positions
            }
            function getMaxPosition() {
                var last = document.positions[document.positions.length - 1]
                return last[0] + last[1].nodeValue.length
            }

            // find the end position for this start position that constitudes a full page
            function findPage(startPosition) {
                var initialJump = 100
                var endPosition = getNextSpaceForPosition(getPositions(), startPosition + initialJump)
                var previousEndPosition = null
                copyTextToPage(getPositions(), startPosition, endPosition)
                while ((! scrollNecessary()) && (endPosition < getMaxPosition())) {
                    previousEndPosition = endPosition
                    endPosition = getNextSpaceForPosition(getPositions(), endPosition + 1)
                    copyTextToPage(getPositions(), startPosition, endPosition)
                }
                if (scrollNecessary() && previousEndPosition != null) {
                    copyTextToPage(getPositions(), startPosition, previousEndPosition)
                    return previousEndPosition
                } else {
                    return endPosition
                }
            }

            function findPages() {
                var pages = []
                pages.push(0)
                while (pages[pages.length - 1] < getMaxPosition() && pages.length < 100) {
                    var endPosition = findPage(pages[pages.length - 1])
                    pages.push(endPosition)
                }
                clearPage()
                document.pages = pages
                document.currentPage = 0
                copyTextToPage(getPositions(), document.pages[0], document.pages[1])
            }


            function copyTextToPage(positions, from, to) {
                var range = document.createRange()

                var startEl = getElementForPosition(positions, from)
                var startElement = startEl[1]
                var locationInStartEl = from - startEl[0]
                range.setStart(startElement, locationInStartEl)

                var endEl = getElementForPosition(positions, to)
                var locationInEndEl = to - endEl[0]
                range.setEnd(endEl[1], locationInEndEl)

                var page = document.getElementById("page")
                page.innerHTML = ""
                page.appendChild(range.cloneContents())
            }

            function getNextSpaceForPosition(positions, position) {
                var index = null
                for (var i = 1; i < positions.length-1; i++) {
                    if (positions[i][0] > position) {
                        index = i - 1
                        break
                    }
                }
                if (index == null) return getMaxPosition()

                var nextSpaceInElementText = findSpaceAfter(positions[index][1].nodeValue, position - positions[index][0])

                if (nextSpaceInElementText < positions[index][1].nodeValue.length) {
                    return positions[index][0] + nextSpaceInElementText
                } else {
                    if (index < positions.length-1) {
                        return positions[index+1][0]
                    } else {
                        return getMaxPosition()
                    }
                }
            }

            function scrollNecessary() {
                return (document.body.scrollWidth > document.body.clientWidth) || (document.body.scrollHeight > document.body.clientHeight)
            }
        </script>
    </head>
    <body>
        <div id="content"></div>
        <div id="prev"></div>
        <div id="next"></div>
        <div id="page"></div>
        <script>
            var prev = document.getElementById("prev")
            prev.addEventListener("click", function() {
                previousPage()
            })
            var next = document.getElementById("next")
            next.addEventListener("click", function() {
                nextPage()
            })

            getData(() => {
                var positions = computeStartPositionsOfElements(document.getElementById("content"))
                setPositions(positions)
                findPages()
            })
        </script>
    </body>
</html>