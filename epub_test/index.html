<html>
    <head>
        <style>
            #prev {
                display: block;
                position: fixed;
                top: 0;
                left: 0;
                width: 5vw;
                height: 100vh;
                background-color: red;
            }
            #next {
                display: block;
                position: fixed;
                top: 0;
                right: 0;
                width: 5vw;
                height: 100vh;
                background-color: blue;
            }
            .page {
                border: 1px solid red;
                padding: 2em;
                margin: 5vw;
                width: 50vw;
            }
        </style>
        <script>
            function getData(callback) {
                var xhttp = new XMLHttpRequest()
                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200 && this.responseText.length > 0) {
                        callback(this.responseText)
                    }
                }
                xhttp.open("GET", "part0005.html", true)
                xhttp.send()
            }
            function extractContents(data, rc, callback) {
                let parser = new DOMParser()
                let doc = parser.parseFromString(data, "text/html")
                let content = doc.querySelectorAll("body > *")
                //var bigPage = document.querySelector(".page")
                var bigPage = document.createElement("div")
                bigPage.classList.add("page")
                document.body.appendChild(bigPage)

                for (var i = 0; i < content.length; i++) {
                    bigPage.appendChild(content[i])
                }

                
                splitBigPage(rc)
                /*findSplitPositions(bigPage)
                console.log(splits)
                for (var i = 0; i < splits.length; i++) {
                    var pages = document.querySelectorAll(".page")
                    var page = pages[pages.length - 1]
                    var range = document.createRange()
                    range.setStart(page, 0)
                    range.setEnd(splits[i].e, splits[i].p)
                    var c = range.extractContents()
                    document.body.insertBefore(toPage(c), page)
                }*/
                if (callback != null) callback()
            }
            function splitBigPage(rc) {
                var keepSplitting = true
                var threshold = rc.rows * rc.columns
                console.log("threshold chars: " + threshold)
                while (keepSplitting) {
                    var pages = document.querySelectorAll(".page")
                    var page = pages[pages.length - 1]
                    var charactersInPage = countCharactersInDom(page, rc.columns)
                    //console.log("characters in page: " + charactersInPage)
                    if (charactersInPage > threshold) {
                        var splittedElement = split(page, threshold, rc.columns)
                        document.body.insertBefore(toPage(splittedElement), page)
                    } else {
                        keepSplitting = false
                    }
                }
            }
            function toPage(content) {
                var div = document.createElement("div")
                div.classList.add("page")
                div.append(content)
                return div
            }
            function countCharactersInDom(el, charsInRow) {
                // https://www.w3schools.com/jsref/prop_node_nodetype.asp
                if (el.nodeType == Node.TEXT_NODE) {
                    return el.nodeValue.length
                } else if (el.nodeType == Node.ELEMENT_NODE) {
                    var count = 0
                    if (el.tagName == "p") count = count + charsInRow * 3
                    var children = el.childNodes
                    for (var i = 0; i < children.length; i++) {
                        
                        count = count + countCharactersInDom(children[i], charsInRow)
                    }
                    return count
                } else {
                    return 0
                }
            }
            // split a node into two nodes, based on a character count
            // go through the node recursively, find the position where the split should be made
            // https://stackoverflow.com/questions/7237865/splitting-node-content-in-javascript-dom
            // https://developer.mozilla.org/en-US/docs/Web/API/Range/Range
            function split(node, chars, charsInRow) {
                var range = document.createRange()
                range.setStart(node, 0)
                var nodeForPosition = findNodeForPosition(node, chars, charsInRow)
                //console.log("found node for position: " + chars)
                //console.log(nodeForPosition)
                range.setEnd(nodeForPosition.e, nodeForPosition.p)
                //range.setEnd(node, chars)
                var c = range.extractContents()
                return c
            }
            function findNodeForPosition(el, position, charsInRow) {
                if (el.nodeType == Node.TEXT_NODE) {
                    if (el.nodeValue.length >= position) {
                        var hardSplit = position
                        var softSplit = positionOfSpaceBefore(el.nodeValue, hardSplit)
                        return { "e": el, "p": softSplit }
                    } else {
                        return null
                    }
                } else if (el.nodeType == Node.ELEMENT_NODE) {
                    var children = el.childNodes
                    var remainingPosition = position
                    for (var i = 0; i < children.length; i++) {
                        var node = findNodeForPosition(children[i], remainingPosition, charsInRow)
                        if (node != null) {
                            return node
                        } else {
                            remainingPosition = remainingPosition - countCharactersInDom(children[i], charsInRow)
                        }
                    }
                }
                return null
            }

            function positionOfSpaceBefore(str, pos) {
                for (var i = pos; i > 0; i--) {
                    if (str.charAt(i) == ' ') return i
                }
                return 0
            }

            function displayPage(num) {
                var pages = document.querySelectorAll(".page")
                for (var i = 0; i < pages.length; i++) {
                    pages[i].style.display = "none"
                }
                pages[num].style.display = "block"

            }
            function computeRowsAndColumns() {
                var div = document.createElement("div")
                div.classList.add("page")
                document.body.appendChild(div)
                var c = 0
                var testText = "test "
                var rows = 0
                var columns = []
                var divHeight = div.clientHeight
                while (! scrollNecessary()) {
                    div.appendChild(document.createTextNode(testText))
                    if (divHeight < div.clientHeight) {
                        // jumped to a new row
                        rows = rows + 1
                        divHeight = div.clientHeight
                        columns.push(0)
                    }
                    columns[columns.length-1] += testText.length
                    c = c + testText.length
                }
                rows = rows - 1
                c = c - testText.length
                var avgc = Math.floor(c / rows)
                document.body.removeChild(div)
                return { "columns": avgc, "rows": rows }

            }
            function scrollNecessary() {
                return (document.body.scrollWidth > document.body.clientWidth) || (document.body.scrollHeight > document.body.clientHeight)
            }
        </script>
    </head>
    <body>
        <div id="prev"></div>
        <div id="next"></div>
        <script>
            var currentPage = 0
            var prev = document.getElementById("prev")
            prev.addEventListener("click", function() {
                currentPage = currentPage - 1
                displayPage(currentPage)
            })
            var next = document.getElementById("next")
            next.addEventListener("click", function() {
                currentPage = currentPage + 1
                displayPage(currentPage)
            })

            var rc = computeRowsAndColumns()
            //var charsInPage = rc.rows * rc.columns
            //console.log(charsInPage)
            getData((data) => extractContents(data, rc, () => displayPage(0)))
        </script>
    </body>
</html>