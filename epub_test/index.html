<html>
    <head>
        <style>
            .page {
                border: 1px solid red;
                padding: 2em;
                margin: 2em;
                width: 50vw;
            }
        </style>
        <script>
            function getData(callback) {
                var xhttp = new XMLHttpRequest()
                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200 && this.responseText.length > 0) {
                        callback(this.responseText)
                    }
                }
                xhttp.open("GET", "part0005.html", true)
                xhttp.send()
            }
            function extractContents(data) {
                let parser = new DOMParser()
                let doc = parser.parseFromString(data, "text/html")
                let content = doc.querySelectorAll("body > *")
                var bigPage = document.querySelector(".page")

                for (var i = 0; i < content.length; i++) {
                    bigPage.appendChild(content[i])
                }

                
                splitBigPage()
                /*findSplitPositions(bigPage)
                console.log(splits)
                for (var i = 0; i < splits.length; i++) {
                    var pages = document.querySelectorAll(".page")
                    var page = pages[pages.length - 1]
                    var range = document.createRange()
                    range.setStart(page, 0)
                    range.setEnd(splits[i].e, splits[i].p)
                    var c = range.extractContents()
                    document.body.insertBefore(toPage(c), page)
                }*/
            }
            function splitBigPage() {
                var keepSplitting = true
                var threshold = 1000
                while (keepSplitting) {
                    var pages = document.querySelectorAll(".page")
                    var page = pages[pages.length - 1]
                    var charactersInPage = countCharactersInDom(page)
                    //console.log("characters in page: " + charactersInPage)
                    if (charactersInPage > threshold) {
                        var splittedElement = split(page, threshold)
                        document.body.insertBefore(toPage(splittedElement), page)
                    } else {
                        keepSplitting = false
                    }
                }
            }
            function toPage(content) {
                var div = document.createElement("div")
                div.classList.add("page")
                div.append(content)
                return div
            }
            function countCharactersInDom(el) {
                // https://www.w3schools.com/jsref/prop_node_nodetype.asp
                if (el.nodeType == Node.TEXT_NODE) {
                    return el.nodeValue.length
                } else if (el.nodeType == Node.ELEMENT_NODE) {
                    var count = 0
                    var children = el.childNodes
                    for (var i = 0; i < children.length; i++) {
                        count = count + countCharactersInDom(children[i])
                    }
                    return count
                } else {
                    return 0
                }
            }
            // split a node into two nodes, based on a character count
            // go through the node recursively, find the position where the split should be made
            // https://stackoverflow.com/questions/7237865/splitting-node-content-in-javascript-dom
            // https://developer.mozilla.org/en-US/docs/Web/API/Range/Range
            function split(node, chars) {
                var range = document.createRange()
                range.setStart(node, 0)
                var nodeForPosition = findNodeForPosition(node, chars)
                //console.log("found node for position: " + chars)
                //console.log(nodeForPosition)
                range.setEnd(nodeForPosition.e, nodeForPosition.p)
                //range.setEnd(node, chars)
                var c = range.extractContents()
                return c
            }
            function findNodeForPosition(el, position) {
                if (el.nodeType == Node.TEXT_NODE) {
                    if (el.nodeValue.length >= position) {
                        var hardSplit = position
                        var softSplit = positionOfSpaceBefore(el.nodeValue, hardSplit)
                        return { "e": el, "p": softSplit }
                    } else {
                        return null
                    }
                } else if (el.nodeType == Node.ELEMENT_NODE) {
                    var children = el.childNodes
                    var remainingPosition = position
                    for (var i = 0; i < children.length; i++) {
                        var node = findNodeForPosition(children[i], remainingPosition)
                        if (node != null) {
                            return node
                        } else {
                            remainingPosition = remainingPosition - countCharactersInDom(children[i])
                        }
                    }
                }
                return null
            }

            var splits = []
            var pageCharacterThreshold = 1000
            var currentCharacters = 0

            function positionOfSpaceBefore(str, pos) {
                for (var i = pos; i > 0; i--) {
                    if (str.charAt(i) == ' ') return i
                }
                return 0
            }

            function findSplitPositions(current) {
                if (current.nodeType == Node.TEXT_NODE) {
                    if (current.nodeValue.length + currentCharacters > pageCharacterThreshold) {
                        console.log("part " + splits.length)
                        // there's a split point in here
                        console.log(current.nodeValue)
                        console.log("current characters: " + currentCharacters)
                        console.log("current node length: " + current.nodeValue.length)
                        var hardSplit = current.nodeValue.length - (pageCharacterThreshold - currentCharacters)
                        console.log("hard spliut: " + hardSplit)
                        var softSplit = positionOfSpaceBefore(current.nodeValue, hardSplit)
                        console.log("soft split: " + softSplit)
                        splits.push({"e": current, "p": softSplit})
                        currentCharacters = current.nodeValue.length - softSplit
                        console.log("current characters after split: " + currentCharacters)
                    } else {
                        currentCharacters = currentCharacters + current.nodeValue.length
                        console.log("cc: " + currentCharacters)
                    }
                } else if (current.nodeType == Node.ELEMENT_NODE) {
                    var children = current.childNodes
                    for (var i = 0; i < children.length; i++) {
                        findSplitPositions(children[i])
                    }
                }
            }
        </script>
    </head>
    <body>
        <div class="page"></div>
        <script>
            getData(extractContents)
        </script>
    </body>
</html>