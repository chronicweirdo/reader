<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Comics Reader</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            border: 0;
        }
        body {
            padding-top: 4em;
        }
        header {
            display: block;
            width: 100%;
            height: 2em;
            top: 0;
            background-color: black;
            color: white;
            font-size: 2em;
            position: fixed;
            z-index: 1000;
        }
        header a {
            margin-top: .2em;
            margin-left: .2em;
            border: 1px solid white;
            padding: .2em;
            display: inline-block
        }
        h1 {
            margin: .5vw;
        }
        .imgdiv {
            position: relative;
            display: inline-block;
            width: 9vw;
            height: 15vw;
            overflow: hidden;
            text-decoration: none;
            margin: .5vw;
        }
        .imgdiv.selected {
            width: 8.6vw;
            height: 14.6vw;
            border: .2vw solid red;
        }
        @media	only screen and (-webkit-min-device-pixel-ratio: 1.3),
        only screen and (-o-min-device-pixel-ratio: 13/10),
        only screen and (min-resolution: 120dpi)
        {
            .imgdiv {
                width: 22vw;
                height: 37vw;
                margin: 1vw;
            }
            .imgdiv.selected {
                width: 21vw;
                height: 36vw;
                border: .5vw solid red;
            }
        }
        .imgdiv img {
            position: relative;
        }
        .imgdiv .pagenum {
            position: absolute;
            right: 10px;
            bottom: 10px;
            background-color: white;
            padding: .5em;
            font-size: 1.2em;
            font-weight: bold;
            color: black;
        }
        .imgdiv .progressbar {
            position: absolute;
            display: block;
            left: 4%;
            bottom: 4%;
            width: 88%;
            height: 4%;
            background-color: white;
            border: 1px solid black;
            padding: 1%;
        }
        .imgdiv .progressbar .read {
            display: block;
            background-color: black;
            height: 98%;
        }
        .latestRead {
            border-bottom: 2px solid black;
        }
    </style>
    <!--script src="hammer.min.js"></script-->
    <script>
        function addPagenum(image, page, totalPages) {
            var span = document.createElement("span")
            span.innerText = page + " / " + totalPages
            span.classList.add("pagenum")
            image.parentElement.appendChild(span)
        }
        function addProgress(image, page, totalPages) {
            var span = document.createElement("span")
            span.classList.add("progressbar")
            span.title = "read " + page + " of " + totalPages + " pages"
            var prog = document.createElement("span")
            prog.classList.add("read")
            prog.style.width = (page / totalPages * 100) + "%"
            span.appendChild(prog)
            image.parentElement.appendChild(span)
        }
        function scaleImage(image, page, totalPages) {
            if (page >= 0) {
                //addPagenum(image, page, totalPages)
                addProgress(image, page, totalPages)
            }
            var imageContainer = document.getElementsByClassName("imgdiv")[0]
            var expectedHeight = imageContainer.offsetHeight
            var expectedWidth = imageContainer.offsetWidth
            if (image.naturalWidth / image.naturalHeight > expectedWidth / expectedHeight) {
                image.style.height = "100%"
            } else {
                image.style.width = "100%"
            }
            var differenceWidth = image.offsetWidth - expectedWidth
            var differenceHeight = image.offsetHeight - expectedHeight
            image.style.left = (- differenceWidth / 2) + "px"
            image.style.top = (- differenceHeight / 2) + "px"

            //enableTouchGestures(image)
            image.addEventListener('contextmenu', function(ev) {
                ev.preventDefault();
                toggleSelect(image)
            }, false);
        }
        // hammer does not work as well in this context
        // better to just keep with overriding the browser right click functionality
        /*function enableTouchGestures(image) {
            //disableEventHandlers(element)
            var hammertime = new Hammer(image, {
                domEvents: true
                });

            hammertime.on('press', function(ev) {
                ev.preventDefault()
                //console.log("pressed")
                toggleSelect(image)
            });
        }*/
        function toggleSelect(image) {
            image.parentElement.classList.toggle("selected")
            setActionsStatus()
        }
        function setActionsStatus() {
            if (document.getElementsByClassName("selected").length > 0) {
                document.getElementById("clearSelectionButton").removeAttribute("disabled")
                document.getElementById("removeProgressButton").removeAttribute("disabled")
            } else {
                document.getElementById("clearSelectionButton").setAttribute("disabled", "disabled")
                document.getElementById("removeProgressButton").setAttribute("disabled", "disabled")
            }
        }
        function clearSelection() {
            var selected = document.getElementsByClassName("selected")
            while (selected.length > 0) {
                selected.item(0).classList.remove("selected")
            }
            setActionsStatus()
        }
        function selectAll() {
            var comics = document.getElementsByClassName("imgdiv")
            for (var i = 0; i < comics.length; i++) {
                comics.item(i).classList.add("selected")
            }
            setActionsStatus()
        }
        function getSelectedIds() {
            var selected = document.getElementsByClassName("selected")
            var ids = []
            for (var i = 0; i < selected.length; i++) {
                ids.push(parseInt(selected.item(i).getAttribute("comicid")))
            }
            return ids
        }
        function removeProgress() {
            var selectedIds = getSelectedIds()
            if (selectedIds.length > 0) {
                var body = {
                    "ids": selectedIds
                }


                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        console.log("success")
                        clearSelection()
                    } else if (this.readyState == 4) {
                        console.log(this.status)
                    }
                };
                xhttp.open("POST", "removeProgress", true);
                xhttp.setRequestHeader('Content-type', 'application/json');
                console.log(body)
                console.log(JSON.stringify(body))
                xhttp.send(JSON.stringify(body));
            }
        }
    </script>
</head>
<body>
<header>
    <a id="clearSelectionButton" class="disabled" onclick="clearSelection()">clear selection</a>
    <a id="selectAllButton" onclick="selectAll()">select all</a>
    <a id="removeProgressButton" class="disabled" onclick="removeProgress()">remove progress</a>
    <a href="/logout">logout</a>
</header>
<!--p th:text="${user}">user name</p-->
<div class="latestRead" th:unless="${#lists.isEmpty(latestRead)}">
    <h1>Latest Read</h1>
    <p><a class="imgdiv" th:each="comic: ${latestRead}" th:href="'comic?id=' + ${comic.id}" th:attr="comicid=${comic.id}">
        <img th:attr="onload='scaleImage(this,' + ${comic.progress} + ',' + ${comic.pages} + ')'" th:src="${comic.cover}" th:title="${comic.title}">
    </a></p>
</div>
<div th:each="collection: ${comicCollections}">
    <h1 th:text="${collection.name}">Collection Name</h1>
    <p>
        <a class="imgdiv" th:each="comic: ${collection.comics}" th:href="'comic?id=' + ${comic.id}">
            <img th:attr="onload='scaleImage(this,' + ${comic.progress} + ',' + ${comic.pages} + ')'" th:src="${comic.cover}" th:title="${comic.title}">
        </a></p>
</div>
</body>
</html>