<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Comics Reader</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            border: 0;
        }
        #removeProgressButton {
            display: block;
            position: fixed;
            z-index: 1000;
            margin-top: .2em;
            margin-right: .2em;
            background-color: gold;
            color: black;
            padding: .2em;
            display: inline-block;
            top: 0;
            right: 0;
        }
        #removeProgressButton img {
            width: 3vw;
        }
        #removeProgressButton.disabled {
            display: none;
        }
        h1 {
            margin: .5vw;
        }
        .tools {
            display: block;
            width: 100vw;
            /*background-color: #52B788;*/
            /*background-color: #1BC475;*/
            background-color: black;
            color: gold;
            font-size: 2em;
            padding-top: 1em;
            padding-bottom: 1em;
            text-align: center;
            max-width: 100%;
        }
        #collections {
            position: absolute;
            display: none;
            width: 100vw;
            width: 100%;
            background-color: black;
            color: white;
            top: 0;
            left: 0;
            z-index: 2000;
            font-size: 1.5em;
        }
        #collections.visible {
            display: block;
        }
        #collections p {
            display: block;
            overflow: scroll;
        }
        #collections ul {
            margin-left: 30px;
        }
        #search {
            font-size: 1em;
            background-color: gold;
            padding: .1em;
            width: 70vw;
            color: black;
            border-style: solid;
            border-width: 2px;
            border-color: white;
        }
        #search::placeholder {
            color: #444444;
            font-style: italic;
        }
        .tools .bigseparator {
            display: inline-block;
            width: 4vw;
        }
        .tools .smallseparator {
            display: inline-block;
            width: 1vw;
        }
        .tools a {
            color: gold;
            text-decoration: underline;
        }
        .imgdiv {
            position: relative;
            display: inline-block;
            width: 15vw;
            height: 25vw;
            overflow: hidden;
            text-decoration: none;
            margin: .5vw;
        }
        .imgdiv.selected {
            width: 13vw;
            height: 23vw;
            border: 1vw solid gold;
        }
        @media	only screen and (-webkit-min-device-pixel-ratio: 1.3),
        only screen and (-o-min-device-pixel-ratio: 13/10),
        only screen and (min-resolution: 120dpi)
        {
            #search {
                width: 90vw;
                margin-bottom: 1em;
            }
            .tools .bigseparator {
                width: 0;
            }
            #removeProgressButton img {
                width: 20vw;
            }
            .imgdiv {
                width: 31vw;
                height: 53vw;
                margin: 1vw;
            }
            .imgdiv.selected {
                width: 25vw;
                height: 47vw;
                border: 3vw solid gold;
            }
        }
        .imgdiv img {
            position: relative;
        }
        .imgdiv .pagenum {
            position: absolute;
            right: 10px;
            bottom: 10px;
            background-color: white;
            padding: .5em;
            font-size: 1.2em;
            font-weight: bold;
            color: black;
        }
        .imgdiv .progressbar {
            position: absolute;
            display: block;
            left: 4%;
            bottom: 4%;
            width: 88%;
            height: 4%;
            background-color: white;
            border: 1px solid black;
            padding: 1%;
        }
        .imgdiv .progresscheck {
            position: absolute;
            display: block;
            right: 4%;
            bottom: 4%;
            padding: 2% 10%;
            font-weight: bold;
            font-size: 1.2em;
            background-color: white;
            border: 1px solid black;
        }
        .imgdiv .progressbar .read {
            display: block;
            background-color: black;
            height: 98%;
        }
        #fin {
            font-weight: normal;
            font-style: italic;
            text-align: center;
        }
    </style>
    <script>
        function addPagenum(image, page, totalPages) {
            var span = document.createElement("span")
            span.innerText = page + " / " + totalPages
            span.classList.add("pagenum")
            image.parentElement.appendChild(span)
        }
        function addProgress(image, page, totalPages) {
            var span = document.createElement("span")
            if (page < totalPages - 1) {
                span.classList.add("progressbar")
                span.title = "read " + (page + 1) + " of " + totalPages + " pages"
                var prog = document.createElement("span")
                prog.classList.add("read")
                prog.style.width = (page / (totalPages-1) * 100) + "%"
                span.appendChild(prog)
            } else {
                span.innerText = "\u2713"
                span.classList.add("progresscheck")
            }
            image.parentElement.appendChild(span)
        }
        function scaleImage(image, page, totalPages) {
            if (page >= 0) {
                addProgress(image, page, totalPages)
            }
            var imageContainer = document.getElementsByClassName("imgdiv")[0]
            var expectedHeight = imageContainer.offsetHeight
            var expectedWidth = imageContainer.offsetWidth
            if (image.naturalWidth / image.naturalHeight > expectedWidth / expectedHeight) {
                image.style.height = "100%"
            } else {
                image.style.width = "100%"
            }
            var differenceWidth = image.offsetWidth - expectedWidth
            var differenceHeight = image.offsetHeight - expectedHeight
            image.style.left = (- differenceWidth / 2) + "px"
            image.style.top = (- differenceHeight / 2) + "px"

            addComicRightClickListener(image)
        }
        function addComicRightClickListener(image) {
            image.addEventListener('contextmenu', function(ev) {
                ev.preventDefault()
                toggleSelect(image)
            }, false);
        }
        function toggleSelect(image) {
            image.parentElement.classList.toggle("selected")
            setActionsStatus()
        }
        function setActionsStatus() {
            if (document.getElementsByClassName("selected").length > 0) {
                document.getElementById("removeProgressButton").classList.remove("disabled")
            } else {
                document.getElementById("removeProgressButton").classList.add("disabled")
            }
        }
        function clearSelection() {
            var selected = document.getElementsByClassName("selected")
            while (selected.length > 0) {
                selected.item(0).classList.remove("selected")
            }
            setActionsStatus()
        }
        function getSelectedIds() {
            var selected = document.getElementsByClassName("selected")
            var ids = []
            for (var i = 0; i < selected.length; i++) {
                ids.push(parseInt(selected.item(i).getAttribute("comicid")))
            }
            return ids
        }
        function removeProgress() {
            var selectedIds = getSelectedIds()
            if (selectedIds.length > 0) {
                var body = {
                    "ids": selectedIds
                }
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        clearSelection()
                        window.location.reload(false)
                    }
                };
                xhttp.open("POST", "removeProgress", true);
                xhttp.setRequestHeader('Content-type', 'application/json');
                xhttp.send(JSON.stringify(body));
            }
        }
        function getCollectionId(collection) {
            if (collection.length == 0) return "default"
            else return encodeURIComponent(collection)
        }
        function getCollectionHtml(collection) {
            var collectionId = getCollectionId(collection)
            var div = document.createElement("div")
            div.id = collectionId
            div.classList.add("collection-container")
            var h1 = document.createElement("h1")
            h1.innerHTML = collection
            div.appendChild(h1)
            return div
        }
        function insertCollectionHtml(collectionHtml) {
            var fin = document.getElementById("fin")
            if (fin != null) {
                document.body.insertBefore(collectionHtml, fin)
            } else {
                document.body.appendChild(collectionHtml)
            }
        }
        function addCollections(collections) {
            for (var i = 0; i < collections.length; i++) {
                var collectionId = getCollectionId(collections[i])
                if (document.getElementById(collectionId) == null) {
                    insertCollectionHtml(getCollectionHtml(collections[i]))
                }
            }
        }
        function getComicHtml(comic) {
            var a = document.createElement("a")
            a.classList.add("imgdiv")
            a.href = "comic?id=" + comic.id
            a.setAttribute("comicid", comic.id)
            var img = document.createElement("img")
            img.onload = function() {
                scaleImage(img, comic.progress, comic.pages)
            }
            img.src = comic.cover
            img.title = comic.title
            a.appendChild(img)
            return a
        }
        function addComics(comics) {
            for (var i = 0; i < comics.length; i++) {
                var comic = comics[i]
                var collectionId = getCollectionId(comic.collection)
                var collectionDiv = document.getElementById(collectionId)
                if (collectionDiv != null) {
                    collectionDiv.appendChild(getComicHtml(comic))
                }
            }
        }
        function setCurrentPage(currentPage) {
            document.currentPage = currentPage
        }
        function getCurrentPage() {
            if (document.currentPage) {
                return document.currentPage
            } else {
                document.currentPage = 0
                return document.currentPage
            }
        }
        function setEndOfCollection() {
            if (! getEndOfCollection()) {
                var fin = document.createElement("h1")
                fin.id = "fin"
                fin.innerHTML = "~ Fin ~"
                document.body.appendChild(fin)
            }
        }
        function getEndOfCollection() {
            return document.getElementById("fin") != null
        }
        function removeExistingComics() {
            var collections = document.getElementsByClassName("collection-container")
            while (collections.length > 0) {
                document.body.removeChild(collections.item(0))
            }
            var fin = document.getElementById("fin")
            if (fin != null) {
                document.body.removeChild(fin)
            }
        }
        function getSearch() {
            return document.getElementById("search")
        }
        function getTerm() {
            return getSearch().value
        }
        function searchForTerm() {
            removeExistingComics()
            setCurrentPage(0)
            loadPage(getCurrentPage(), loadUntilPageFull)
        }
        function loadPage(pagenum, callback) {
            var term = getTerm()
            console.log(term)
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    var response = JSON.parse(this.responseText)
                    if (response.comics.length > 0) {
                        addCollections(response.collections)
                        addComics(response.comics)
                    } else {
                        setEndOfCollection()
                    }
                    if (callback != null) callback()
                }
            }
            xhttp.open("GET", "search?term=" + term + "&page=" + pagenum, true)
            xhttp.send()
        }
        function loadCollections(callback) {
            var xhttp = new XMLHttpRequest()
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    var collections = JSON.parse(this.responseText)
                    //console.log(collections)
                    if (callback != null) {
                        callback(collections)
                    }
                }
            }
            xhttp.open("GET", "collections", true)
            xhttp.send()
        }
        function createCollectionsUl(collections) {
            var ul = document.createElement("ul")

            collections.forEach(c => {
                var li = document.createElement("li")
                li.innerText = c
                ul.appendChild(li)
            })

            return ul
        }
        function showCollectionsDialog() {
            loadCollections(function(collections) {
                var collectionsUl = createCollectionsUl(collections)
                var collectionsDialog = document.getElementById("collections")
                var collectionsContent = collectionsDialog.getElementsByTagName("p")[0]
                collectionsContent.appendChild(collectionsUl)
                collectionsDialog.classList.add("visible")
            })
        }
        function hideCollectionsDialog() {
            var collectionsDialog = document.getElementById("collections")
            var collectionsContent = collectionsDialog.getElementsByTagName("p")[0]
            collectionsContent.innerHTML = ""
            collectionsDialog.classList.remove("visible")
        }
        function getViewportHeight() {
            return Math.max(document.documentElement.clientHeight, window.innerHeight || 0)
        }
        function getScrollTop() {
            return document.documentElement.scrollTop
        }
        function getDocumentHeight() {
            return document.body.offsetHeight
        }
        function loadUntilPageFull() {
            if ((document.body.offsetHeight <= getViewportHeight()) && ! getEndOfCollection()) {
                setCurrentPage(getCurrentPage() + 1)
                loadPage(getCurrentPage(), loadUntilPageFull)
            }
        }
        function addBodyRightClickListener() {
            document.body.addEventListener("contextmenu", function(ev) {
                var tag = ev.target.tagName.toLowerCase()
                if (tag != "img" && tag != "a" && tag != "input") {
                    ev.preventDefault()
                    clearSelection()
                }
            })
        }
        function addSearchTriggerListener() {
            var search = document.getElementById("search")
            search.addEventListener('keyup', function (e) {
                if (document.searchTimeout && document.searchTimeout != null) {
                    window.clearTimeout(document.searchTimeout)
                    document.searchTimeout = null
                }
                if (e.keyCode === 13) {
                    // if enter, search
                    searchForTerm()
                } else {
                    // if other key, wait to see if finished typing
                    document.searchTimeout = window.setTimeout(searchForTerm, 1000)
                }
            })
        }
    </script>
</head>
<body>
<a id="removeProgressButton" class="disabled" onclick="removeProgress()" title="Delete saved progress"><img src="trash.png"></a>
<div class="latestRead" th:unless="${#lists.isEmpty(latestRead)}">
    <h1>Latest Read</h1>
    <p><a class="imgdiv" th:each="comic: ${latestRead}" th:href="'comic?id=' + ${comic.id}" th:attr="comicid=${comic.id}">
        <img th:attr="onload='scaleImage(this,' + ${comic.progress} + ',' + ${comic.pages} + ')'" th:src="${comic.cover}" th:title="${comic.title}">
    </a></p>
</div>
<div class="tools"><input name="search" id="search" type="text" placeholder="Search"/><span class="bigseparator"></span><a id="showCollectionsButton" onclick="showCollectionsDialog()">collections</a><span class="smallseparator"></span><a id="help" href="/help">help</a><span class="smallseparator"></span><a id="logout" href="/logout">logout</a></div>
<div id="collections">
    <h1>A list of collections, so you know what to search <a onclick="hideCollectionsDialog()">close</a></h1>
    <p></p>
</div>
<script>
    var scrollThreshold = 20

    window.onload = function() {
        addBodyRightClickListener()
        addSearchTriggerListener()
        searchForTerm()
    }
    window.onscroll = function(ev) {
        if ((getViewportHeight() + getScrollTop()) >= getDocumentHeight() - scrollThreshold) {
            if (! getEndOfCollection()) {
                setCurrentPage(getCurrentPage() + 1)
                loadPage(getCurrentPage(), null)
            }
        }
    }
</script>
</body>
</html>