<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Comics Reader</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            border: 0;
        }
        header {
            display: block;
            width: 100%;
            height: 2em;
            top: 0;
            text-align: right;
            font-size: 2em;
            position: fixed;
            z-index: 1000;
        }
        header a {
            margin-top: .2em;
            margin-right: .2em;
            background-color: gold;
            color: black;
            padding: .2em;
            display: inline-block
        }
        header a.disabled {
            display: none;
        }
        h1 {
            margin: .5vw;
        }
        .tools {
            display: block;
            width: 100%;
            background-color: black;
            color: gold;
            font-size: 2em;
            padding-top: 1em;
            padding-bottom: 1em;
            padding-left: .5vw;
            padding-right: .5vw;
            text-align: center;
        }
        .tools #search {
            font-size: 1em;
            background-color: gold;
            padding: .1em;
        }
        .tools a {
            color: gold;
        }
        .imgdiv {
            position: relative;
            display: inline-block;
            width: 9vw;
            height: 15vw;
            overflow: hidden;
            text-decoration: none;
            margin: .5vw;
        }
        .imgdiv.selected {
            width: 7vw;
            height: 13vw;
            border: 1vw solid gold;
        }
        @media	only screen and (-webkit-min-device-pixel-ratio: 1.3),
        only screen and (-o-min-device-pixel-ratio: 13/10),
        only screen and (min-resolution: 120dpi)
        {
            .imgdiv {
                width: 22vw;
                height: 37vw;
                margin: 1vw;
            }
            .imgdiv.selected {
                width: 21vw;
                height: 36vw;
                border: .5vw solid red;
            }
        }
        .imgdiv img {
            position: relative;
        }
        .imgdiv .pagenum {
            position: absolute;
            right: 10px;
            bottom: 10px;
            background-color: white;
            padding: .5em;
            font-size: 1.2em;
            font-weight: bold;
            color: black;
        }
        .imgdiv .progressbar {
            position: absolute;
            display: block;
            left: 4%;
            bottom: 4%;
            width: 88%;
            height: 4%;
            background-color: white;
            border: 1px solid black;
            padding: 1%;
        }
        .imgdiv .progressbar .read {
            display: block;
            background-color: black;
            height: 98%;
        }
        .latestRead {
            border-bottom: 2px solid black;
        }
    </style>
    <!--script src="hammer.min.js"></script-->
    <script>
        function addPagenum(image, page, totalPages) {
            var span = document.createElement("span")
            span.innerText = page + " / " + totalPages
            span.classList.add("pagenum")
            image.parentElement.appendChild(span)
        }
        function addProgress(image, page, totalPages) {
            var span = document.createElement("span")
            span.classList.add("progressbar")
            span.title = "read " + page + " of " + totalPages + " pages"
            var prog = document.createElement("span")
            prog.classList.add("read")
            prog.style.width = (page / totalPages * 100) + "%"
            span.appendChild(prog)
            image.parentElement.appendChild(span)
        }
        function scaleImage(image, page, totalPages) {
            if (page >= 0) {
                //addPagenum(image, page, totalPages)
                addProgress(image, page, totalPages)
            }
            var imageContainer = document.getElementsByClassName("imgdiv")[0]
            var expectedHeight = imageContainer.offsetHeight
            var expectedWidth = imageContainer.offsetWidth
            if (image.naturalWidth / image.naturalHeight > expectedWidth / expectedHeight) {
                image.style.height = "100%"
            } else {
                image.style.width = "100%"
            }
            var differenceWidth = image.offsetWidth - expectedWidth
            var differenceHeight = image.offsetHeight - expectedHeight
            image.style.left = (- differenceWidth / 2) + "px"
            image.style.top = (- differenceHeight / 2) + "px"

            //enableTouchGestures(image)
            image.addEventListener('contextmenu', function(ev) {
                ev.preventDefault();
                toggleSelect(image)
            }, false);
        }
        // hammer does not work as well in this context
        // better to just keep with overriding the browser right click functionality
        /*function enableTouchGestures(image) {
            //disableEventHandlers(element)
            var hammertime = new Hammer(image, {
                domEvents: true
                });

            hammertime.on('press', function(ev) {
                ev.preventDefault()
                //console.log("pressed")
                toggleSelect(image)
            });
        }*/
        function toggleSelect(image) {
            image.parentElement.classList.toggle("selected")
            setActionsStatus()
        }
        function setActionsStatus() {
            if (document.getElementsByClassName("selected").length > 0) {
                document.getElementById("clearSelectionButton").classList.remove("disabled")
                document.getElementById("removeProgressButton").classList.remove("disabled")
            } else {
                document.getElementById("clearSelectionButton").classList.add("disabled")
                document.getElementById("removeProgressButton").classList.add("disabled")
            }
        }
        function clearSelection() {
            var selected = document.getElementsByClassName("selected")
            while (selected.length > 0) {
                selected.item(0).classList.remove("selected")
            }
            setActionsStatus()
        }
        function selectAll() {
            var comics = document.getElementsByClassName("imgdiv")
            for (var i = 0; i < comics.length; i++) {
                comics.item(i).classList.add("selected")
            }
            setActionsStatus()
        }
        function getSelectedIds() {
            var selected = document.getElementsByClassName("selected")
            var ids = []
            for (var i = 0; i < selected.length; i++) {
                ids.push(parseInt(selected.item(i).getAttribute("comicid")))
            }
            return ids
        }
        function removeProgress() {
            var selectedIds = getSelectedIds()
            if (selectedIds.length > 0) {
                var body = {
                    "ids": selectedIds
                }


                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        console.log("success")
                        clearSelection()
                        window.location.reload(false)
                    } else if (this.readyState == 4) {
                        console.log(this.status)
                    }
                };
                xhttp.open("POST", "removeProgress", true);
                xhttp.setRequestHeader('Content-type', 'application/json');
                console.log(body)
                console.log(JSON.stringify(body))
                xhttp.send(JSON.stringify(body));
            }
        }
        function getCollectionId(collection) {
            if (collection.length == 0) return "default"
            else return encodeURIComponent(collection)
        }
        function getCollectionHtml(collection) {
            var collectionId = getCollectionId(collection)
            var div = document.createElement("div")
            div.id = collectionId
            var h1 = document.createElement("h1")
            h1.innerHTML = collection
            div.appendChild(h1)
            return div
        }
        function addCollections(collections) {
            for (var i = 0; i < collections.length; i++) {
                //console.log(collections[i])
                var collectionId = getCollectionId(collections[i])
                //console.log(collectionId)
                if (document.getElementById(collectionId) == null) {
                    document.body.appendChild(getCollectionHtml(collections[i]))
                }
            }
        }
        /*
                <a class="imgdiv" th:each="comic: ${collection.comics}" th:href="'comic?id=' + ${comic.id}">
            <img th:attr="onload='scaleImage(this,' + ${comic.progress} + ',' + ${comic.pages} + ')'" th:src="${comic.cover}" th:title="${comic.title}">
        </a></p>
        */
        function getComicHtml(comic) {
            var a = document.createElement("a")
            a.classList.add("imgdiv")
            a.href = "comic?id=" + comic.id
            var img = document.createElement("img")
            img.onload = function() {
                scaleImage(img, comic.progress, comic.pages)
            }
            img.src = comic.cover
            img.title = comic.title
            a.appendChild(img)
            return a
        }
        function addComics(comics) {
            for (var i = 0; i < comics.length; i++) {
                var comic = comics[i]
                //console.log(comic)
                var collectionId = getCollectionId(comic.collection)
                var collectionDiv = document.getElementById(collectionId)
                if (collectionDiv != null) {
                    collectionDiv.appendChild(getComicHtml(comic))
                }
            }
        }
        var currentPage = 0
        var pagesLeft = true
        function loadPage(pagenum, callback) {
            console.log("loading page " + pagenum)
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    var response = JSON.parse(this.responseText)
                    //console.log(response)
                    if (response.comics.length > 0) {
                        addCollections(response.collections)
                        addComics(response.comics)
                    } else {
                        pagesLeft = false
                    }
                    callback()
                } else if (this.readyState == 4) {
                    console.log(this.status)
                }
            }
            xhttp.open("GET", "comics?page=" + pagenum, true);
            xhttp.send()
        }
        function getViewportHeight() {
            return Math.max(document.documentElement.clientHeight, window.innerHeight || 0)
        }
        function getScrollTop() {
            return document.documentElement.scrollTop
        }
        function getDocumentHeight() {
            return document.body.offsetHeight
        }
    </script>
</head>
<body>
<header>
    <a id="clearSelectionButton" class="disabled" onclick="clearSelection()">clear selection</a>
    <!--a id="selectAllButton" onclick="selectAll()">select all</a-->
    <a id="removeProgressButton" class="disabled" onclick="removeProgress()">remove progress</a>

</header>
<!--p th:text="${user}">user name</p-->
<div class="latestRead" th:unless="${#lists.isEmpty(latestRead)}">
    <h1>Latest Read</h1>
    <p><a class="imgdiv" th:each="comic: ${latestRead}" th:href="'comic?id=' + ${comic.id}" th:attr="comicid=${comic.id}">
        <img th:attr="onload='scaleImage(this,' + ${comic.progress} + ',' + ${comic.pages} + ')'" th:src="${comic.cover}" th:title="${comic.title}">
    </a></p>
</div>
<div class="tools">
    <label for="search">Search:</label>
    <input name="search" id="search" type="text" />
    <a href="/logout">logout</a>
</div>
<!--div th:each="collection: ${comicCollections}">
    <h1 th:text="${collection.name}">Collection Name</h1>
    <p>
        <a class="imgdiv" th:each="comic: ${collection.comics}" th:href="'comic?id=' + ${comic.id}">
            <img th:attr="onload='scaleImage(this,' + ${comic.progress} + ',' + ${comic.pages} + ')'" th:src="${comic.cover}" th:title="${comic.title}">
        </a></p>
</div-->
<script>
    var scrollThreshold = 20
    function loadUntilPageFull() {
        if ((document.body.offsetHeight <= getViewportHeight()) && pagesLeft) {
            currentPage += 1
            loadPage(currentPage, loadUntilPageFull)
        }
    }
    window.onload = function() {
        loadPage(currentPage, loadUntilPageFull)
    }
    function emptyFunction() {
        console.log("empty function")
    }
    window.onscroll = function(ev) {
        console.log("viewport height: " + getViewportHeight())
        console.log("scroll top: " + getScrollTop())
        console.log("document height: " + getDocumentHeight())

        if ((getViewportHeight() + getScrollTop()) >= getDocumentHeight() - scrollThreshold) {
            if (pagesLeft) {
                console.log("trying to load next page on scroll")
                currentPage += 1
                loadPage(currentPage, emptyFunction)
            }
        }
    }
</script>
</body>
</html>